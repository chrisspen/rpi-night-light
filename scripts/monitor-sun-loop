#!/usr/bin/env bash
set -euo pipefail

# Make sure standard admin paths exist under systemd
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# shellcheck disable=SC1091
source /etc/default/monitor-sun

# Validate coordinate format for sunwait (requires N/S/E/W suffix).
if [[ ! "${LAT:-}" =~ ^[0-9]+([.][0-9]+)?[NS]$ ]]; then
  echo "Invalid LAT format in /etc/default/monitor-sun. Use e.g. 35.1595N" >&2
  exit 2
fi
if [[ ! "${LON:-}" =~ ^[0-9]+([.][0-9]+)?[EW]$ ]]; then
  echo "Invalid LON format in /etc/default/monitor-sun. Use e.g. 84.8766W" >&2
  exit 2
fi

# Normalize OFFSET into sunwait's expected format (+H:MM:SS / -H:MM:SS)
OFFSET_NORM="${OFFSET:-+0:00:00}"
if [[ "$OFFSET_NORM" == "0" ]]; then OFFSET_NORM="+0:00:00"; fi
if [[ "$OFFSET_NORM" != +* && "$OFFSET_NORM" != -* ]]; then OFFSET_NORM="+${OFFSET_NORM}"; fi

modprobe i2c-dev >/dev/null 2>&1 || true

while true; do
  # sunwait poll exit codes: 2 = DAY/twilight, 3 = NIGHT
  if sunwait poll "$TWILIGHT" "$LAT" "$LON" >/dev/null 2>&1; then
    rc=0
  else
    rc=$?
  fi

  if [ "$rc" -eq 2 ]; then
    /usr/local/bin/monitor-day
    # Wait until sunset (set)
    sunwait wait set offset "$OFFSET_NORM" "$LAT" "$LON" >/dev/null 2>&1
    /usr/local/bin/monitor-night
  elif [ "$rc" -eq 3 ]; then
    /usr/local/bin/monitor-night
    # Wait until sunrise (rise)
    sunwait wait rise offset "$OFFSET_NORM" "$LAT" "$LON" >/dev/null 2>&1
    /usr/local/bin/monitor-day
  else
    sleep 60
  fi
done
